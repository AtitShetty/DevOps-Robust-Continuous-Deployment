---
- hosts: jenkins

  gather_facts: false

  vars_prompt:
    # - name: username
    #   prompt: "Enter remote username"
    #   private: no
    # - name: jenkinspassword
    #   prompt: "Enter Jenkins Admin Password"
    #   private: yes
    - name: github_username
      prompt: "Enter github username"
      private: no
    - name: github_password
      prompt: "Enter github Password"
      private: yes

  roles:
    # - role: java8_setup
    #   become: true
    # - role: tomcat_setup
    #   become: true
    # - role: mysql_setup
    #   become: true
    # - role: jenkins_setup
    #   become: true
    - role: itrust_jenkins_job_setup
      become: true

  tasks:
    - name: stat /etc/playbooksRepo
      stat:
        path: /etc/playbooksRepo
      register: playbooksRepoStat

    - name: Ensure that directory exists for cloning
      file:
        path: /etc/playbooksRepo
        state: directory
      when: playbooksRepoStat.stat.exists == False
      become: true

    - name: stat "{{ post_build_playbook_path }}"
      stat:
        path: "{{ post_build_playbook_path }}"
      register: postBuildDirStat

    - name: Clone playbook to run jenkins post build scripts
      command: git clone https://{{github_username}}:{{github_password}}@github.ncsu.edu/akshetty/devops-milestone3.git
      args:
        chdir: /etc/playbooksRepo
      when: postBuildDirStat.stat.exists == False
      become: true

    - name: Pull latest playbooksRepo
      command: git pull
      args:
        chdir: "{{ post_build_playbook_path }}"
      when: postBuildDirStat.stat.exists == True
      become: true

    - name: Transfer remote server certificates
      copy:
        src: deployment_env.pem
        dest: "{{ post_build_playbook_path }}"
        owner: jenkins
        group: jenkins
        mode: 0600
      become: true
...
